# Hillium Forge - High-Performance Build Environment
# Version: 1.4.0 (Optimized Cache & Python 3.11 Fix)
FROM ubuntu:22.04

LABEL maintainer="Hillium Engineering Team"
LABEL version="1.4.0"

ENV DEBIAN_FRONTEND=noninteractive

# --- LAYER 1: SYSTEM STABILITY ---
# We keep this at the top because it rarely changes.
RUN apt-get update && apt-get install -y \
    python3.11 python3.11-dev python3-pip python3.11-venv python-is-python3 \
    build-essential cmake libssl-dev protobuf-compiler pkg-config \
    libasound2-dev portaudio19-dev espeak-ng \
    git curl wget ffmpeg libopenblas-dev \
    && rm -rf /var/lib/apt/lists/*

# --- LAYER 2: PYTHON DEFAULT CONFIG ---
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1 && \
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 2 && \
    update-alternatives --set python3 /usr/bin/python3.11 && \
    ln -sf /usr/bin/python3 /usr/bin/python

# --- LAYER 3: HEAVY COMPILATION (COMPILE ONCE) ---
# We do this FIRST so light changes below don't trigger recompilation.
RUN python3.11 -m pip install --no-cache-dir --upgrade pip setuptools wheel
RUN CMAKE_ARGS="-DLLAMA_BLAS=ON -DLLAMA_OPENBLAS=ON" FORCE_CMAKE=1 python3.11 -m pip install --no-cache-dir --break-system-packages \
    llama-cpp-python \
    webrtcvad \
    pyaudio

# --- LAYER 3b: POWERINFER C++ (persistent for Levitate tests / powerinfer-rs) ---
# Levitate runs cargo build and pytest inside Forge; powerinfer-rs may link against
# the native PowerInfer (C++). Ref: Hillium-Forge/docs/ANALISIS_LEVITATE_FORGE_VOLUMENES.md
ARG POWERINFER_REPO=https://github.com/SJTU-IPADS/PowerInfer
ARG POWERINFER_BRANCH=main
RUN git clone --depth 1 --branch "${POWERINFER_BRANCH}" "${POWERINFER_REPO}" /tmp/PowerInfer \
    && cd /tmp/PowerInfer \
    && cmake -B build \
        -DCMAKE_BUILD_TYPE=Release \
        -DBUILD_SHARED_LIBS=ON \
        -DLLAMA_BLAS=ON \
        -DLLAMA_OPENBLAS=ON \
    && cmake --build build -j$(nproc) \
    && cmake --install build --prefix /usr/local \
    && rm -rf /tmp/PowerInfer
ENV LD_LIBRARY_PATH=/usr/local/lib \
    LIBRARY_PATH=/usr/local/lib

# --- LAYER 4: APP DEPENDENCIES (SEMI-STABLE) ---
RUN python3.11 -m pip install --no-cache-dir --break-system-packages \
    pytest>=7.0 pytest-asyncio mypy black ruff \
    faster-whisper torch numpy \
    silero-vad loguru pydantic \
    scipy sounddevice python-dotenv \
    langchain duckdb sqlparse polars pyarrow textual watchfiles \
    RestrictedPython pandas pyyaml

# --- LAYER 5: RUST TOOLCHAIN ---
ENV RUSTUP_HOME=/usr/local/rustup \
    CARGO_HOME=/usr/local/cargo \
    PATH=/usr/local/cargo/bin:$PATH
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.82.0 --no-modify-path && \
    chmod -R 777 /usr/local/rustup /usr/local/cargo && \
    rustup component add clippy rustfmt

# --- LAYER 6: DYNAMIC CONFIG (CHANGES OFTEN) ---
# We put User and Path config at the bottom to avoid invalidating compilation cache.
ARG USER_ID=501
ARG GROUP_ID=20
RUN groupadd -g ${GROUP_ID} forge 2>/dev/null || true && \
    useradd -m -u ${USER_ID} -g ${GROUP_ID} -s /bin/bash forgeuser 2>/dev/null || true

ENV CARGO_TARGET_DIR=/workspace/target \
    RUST_BACKTRACE=1 \
    PYTHONPATH="/workspace" \
    PATH="/home/forgeuser/.local/bin:${PATH}"

WORKDIR /workspace

# Fix permissions for the mounted workspace
RUN mkdir -p /workspace/target /home/forgeuser/.cargo && \
    chown -R ${USER_ID}:${GROUP_ID} /workspace /home/forgeuser/.cargo

USER forgeuser

# Warmup (Optional optimization)
RUN cargo init --name warmup /tmp/warmup && \
    cd /tmp/warmup && \
    echo 'tokio = { version = "1.35", features = ["full"] }' >> Cargo.toml && \
    echo 'sled = "0.34"' >> Cargo.toml && \
    cargo build --release && \
    rm -rf /tmp/warmup

HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
    CMD cargo --version && python3 --version || exit 1

CMD ["tail", "-f", "/dev/null"]
