# Hillium Forge - Unified Build & Test Environment
# Purpose: Provide a consistent, isolated environment for Rust/Python compilation
# Used by: Levitate agents for dynamic verification

FROM rust:1.75-bookworm

# Install Python 3.11 and system dependencies
RUN apt-get update && apt-get install -y \
    python3.11 \
    python3-pip \
    python3.11-venv \
    build-essential \
    cmake \
    libssl-dev \
    protobuf-compiler \
    ninja-build \
    pkg-config \
    libasound2-dev portaudio19-dev \
    espeak-ng \
    redis-tools git curl vim htop wget \
    bash coreutils findutils grep sed gawk procps ffmpeg libopenblas-dev python3-dev \
    python-is-python3 \
    && rm -rf /var/lib/apt/lists/*

# Create pip symlink for legacy command support (Force overwrite if exists)
RUN ln -sf /usr/bin/pip3 /usr/bin/pip

# Install piper-tts binary (v10.7.90: WP-019 Aura Voice support)
RUN cd /tmp && \
    wget -q https://github.com/rhasspy/piper/releases/download/v1.2.0/piper_arm64.tar.gz && \
    tar -xzf piper_arm64.tar.gz && \
    cp -r piper/* /usr/local/bin/ && \
    rm -rf piper piper_arm64.tar.gz && \
    piper --help > /dev/null 2>&1 || echo "piper installed"

# Install Python dependencies (v10.7.70: Audio/AI stack)
RUN pip3 install --no-cache-dir --break-system-packages \
    pytest>=7.0 pytest-asyncio mypy black ruff \
    pyaudio faster-whisper torch numpy \
    silero-vad webrtcvad loguru pydantic \
    scipy sounddevice python-dotenv \
    langchain duckdb sqlparse polars pyarrow textual watchfiles \
    RestrictedPython

# Install Rust tools
RUN rustup component add clippy rustfmt

# Install uv (fast Python package manager)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.cargo/bin:$PATH"

# Set working directory
WORKDIR /workspace
ENV PYTHONPATH="/workspace:${PYTHONPATH}"


# Create a non-root user matching host UID (for file permission parity)
# Default to UID 1000, override via docker-compose if needed
ARG USER_ID=1000
ARG GROUP_ID=1000
RUN groupadd -g ${GROUP_ID} forge || true
RUN useradd -m -u ${USER_ID} -g ${GROUP_ID} -s /bin/bash forgeuser || true

# Switch to non-root user for builds
USER forgeuser

# Pre-warm Cargo cache (optional optimization)
# This creates a dummy project to cache common dependencies
RUN cargo init --name dummy /tmp/warmup && \
    cd /tmp/warmup && \
    echo 'tokio = { version = "1.35", features = ["full"] }' >> Cargo.toml && \
    echo 'sled = "0.34"' >> Cargo.toml && \
    cargo build --release && \
    rm -rf /tmp/warmup

# Set Cargo target directory to a cached volume (speeds up rebuilds)
ENV CARGO_TARGET_DIR=/workspace/target

# Health check: Verify Rust and Python are available
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD cargo --version && python3 --version || exit 1

# Default command: Keep container alive for exec commands
CMD ["tail", "-f", "/dev/null"]
